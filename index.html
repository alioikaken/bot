<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Premium Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #111111; --card-bg: #1c1c1c; --text: #ffffff; --accent: #0088cc; --green: #4caf50; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; -webkit-user-select: none; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .nft-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .nft-item { background: var(--card-bg); border-radius: 12px; padding: 10px; text-align: center; border: 1px solid #222; }
        .nft-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; }
        .price { color: var(--green); font-weight: bold; margin: 8px 0; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px; width: 100%; border-radius: 10px; font-weight: 600; cursor: pointer; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #181818; display: flex; border-top: 1px solid #333; padding: 10px 0; padding-bottom: 25px; }
        .nav-item { flex: 1; text-align: center; color: #666; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }
    </style>
</head>
<body>

<div id="market" class="tab-content active">
    <h2 style="text-align: center;">üî• NFT –ú–∞—Ä–∫–µ—Ç</h2>
    <div id="nft-list" class="nft-grid">
        </div>
</div>

<div id="profile" class="tab-content">
    <h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
    <div class="card">
        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b id="u-name">–ó–∞–≥—Ä—É–∑–∫–∞...</b></p>
        <p>ID: <span id="u-id">---</span></p>
        <hr style="border: 0.1px solid #333;">
        <p>–í–∞—à –ë–∞–ª–∞–Ω—Å: <b class="price" id="u-balance">0.00 $</b></p>
        <p>–°—Ç–∞—Ç—É—Å: <span style="color: #ff4d4d;">–ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</span></p>
        <h3 style="margin-top:20px;">–ú–æ–∏ NFT:</h3>
        <ul id="my-nfts" style="list-style: none; padding: 0;">
            </ul>
        <button class="btn" onclick="tg.showAlert('–î–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É @–í–∞—à_–ù–∏–∫')">–ü—Ä–æ–π—Ç–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</button>
    </div>
</div>

<div id="wallet" class="tab-content">
    <h2>üí≥ –ö–æ—à–µ–ª–µ–∫</h2>
    <div class="card">
        <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞</h3>
        <button class="btn" style="background: #4caf50;" onclick="sendToBot('pay_card')">–ö–∞—Ä—Ç–∞ RU/MIR</button>
        <button class="btn" style="background: #f39c12; margin-top: 10px;" onclick="sendToBot('pay_crypto')">USDT (TRC-20)</button>
    </div>
    <div class="card">
        <h3>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h3>
        <p style="font-size: 13px; color: #888;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 50.00 $</p>
        <button class="btn" style="background:#7f8c8d;" onclick="tg.showAlert('–û—à–∏–±–∫–∞: –í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.')">–í—ã–≤–µ—Å—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—É</button>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="showTab('market', this)"><span class="nav-icon">üõí</span>–ú–∞—Ä–∫–µ—Ç</div>
    <div class="nav-item" onclick="showTab('profile', this)"><span class="nav-icon">üë§</span>–ö–∞–±–∏–Ω–µ—Ç</div>
    <div class="nav-item" onclick="showTab('wallet', this)"><span class="nav-icon">üí≥</span>–ö–æ—à–µ–ª–µ–∫</div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    
    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ ---
    const API_URL = "http://–¢–í–û–ô_IP_–ò–õ–ò_–î–û–ú–ï–ù:5000"; // –ó–ê–ú–ï–ù–ò –ù–ê IP –°–í–û–ï–ì–û –°–ï–†–í–ï–†–ê!
    let currentUserId = null;

    // --- –§—É–Ω–∫—Ü–∏–∏ UI ---
    function showTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if (id === 'profile') loadUserProfile();
    }

    async function loadNFTs() {
        try {
            const response = await fetch(`${API_URL}/get_nfts`);
            const nfts = await response.json();
            const nftListDiv = document.getElementById('nft-list');
            nftListDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫

            for (const category in nfts) {
                if (category === 'id') continue;
                for (const name in nfts[category]) {
                    const nft = nfts[category][name];
                    const nftHtml = `
                        <div class="nft-item">
                            <img src="${nft.photo || 'https://via.placeholder.com/120x120?text=NFT'}" alt="${name}">
                            <div>${name}</div>
                            <div class="price">${nft.price}$</div>
                            <button class="btn" onclick="buyNFT('${category}', '${name}', ${nft.price})">–ö—É–ø–∏—Ç—å</button>
                        </div>
                    `;
                    nftListDiv.innerHTML += nftHtml;
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ NFT:', error);
            tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å NFT. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.');
        }
    }

    async function loadUserProfile() {
        if (!currentUserId) {
            document.getElementById('u-name').innerText = "–ì–æ—Å—Ç—å";
            document.getElementById('u-id').innerText = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
            return;
        }
        try {
            const response = await fetch(`${API_URL}/get_user_data`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentUserId })
            });
            const userData = await response.json();
            document.getElementById('u-balance').innerText = `${userData.balance.toFixed(2)} $`;
            document.getElementById('u-name').innerText = userData.username || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
            
            const myNftsList = document.getElementById('my-nfts');
            myNftsList.innerHTML = '';
            for (const nftName in userData.nft) {
                myNftsList.innerHTML += `<li>- ${nftName} (${userData.nft[nftName].category})</li>`;
            }
            if (Object.keys(userData.nft).length === 0) {
                myNftsList.innerHTML = `<li>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç NFT.</li>`;
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
            tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        }
    }

    async function buyNFT(category, name, price) {
        if (!currentUserId) {
            tg.showAlert('–û—à–∏–±–∫–∞: –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start –≤ Telegram.');
            return;
        }
        tg.showConfirm(`–í—ã —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å ${name} –∑–∞ ${price}$?`, async (ok) => {
            if (ok) {
                try {
                    const response = await fetch(`${API_URL}/buy_nft`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: currentUserId, category, name })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        tg.showAlert(`üéâ ${result.message}`);
                        await loadUserProfile(); // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                    } else {
                        tg.showAlert(`‚ùå ${result.message}`);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏:', error);
                    tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                }
            }
        });
    }

    function sendToBot(action) {
        tg.sendData(action); 
        tg.showAlert('–†–µ–∫–≤–∏–∑–∏—Ç—ã –≤—ã—Å–ª–∞–Ω—ã –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–æ.');
        tg.close();
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ---
    tg.ready();
    tg.headerColor = '#111111';

    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        currentUserId = tg.initDataUnsafe.user.id.toString();
        document.getElementById('u-name').innerText = tg.initDataUnsafe.user.first_name;
        document.getElementById('u-id').innerText = currentUserId;
    } else {
        tg.showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start.');
    }

    loadNFTs(); // –ó–∞–≥—Ä—É–∂–∞–µ–º NFT –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadUserProfile(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
</script>
</body>
</html>
